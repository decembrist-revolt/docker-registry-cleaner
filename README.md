# Docker Registry Cleaner

Программа для автоматической очистки кастомного Docker Registry, которая удаляет все образы кроме 2 последних версий для каждого репозитория **на основе реального времени создания образов**.

## Особенности

✅ **Реальное время создания** - извлекает фактическое время создания из Docker манифестов  
✅ **Умная сортировка** - сортирует по времени создания, а не по алфавиту тегов  
✅ **Сохраняет новые образы** - всегда оставляет 2 самых свежих образа  
✅ **Проверка поддержки удаления** - автоматически проверяет настройки Registry  
✅ **Подробное логирование** - показывает весь процесс с временными метками  

## Использование

### Настройка переменных окружения

Перед запуском программы установите следующие переменные окружения:

```bash
# URL вашего Docker Registry (обязательно)
set REGISTRY_URL=http://your-registry-url:5000

# Имя пользователя для аутентификации (опционально)
set REGISTRY_USERNAME=your-username

# Пароль для аутентификации (опционально)  
set REGISTRY_PASSWORD=your-password
```

### Запуск программы

```bash
registry-cleaner.exe
```

## Что делает программа

1. **Проверяет поддержку удаления** в Docker Registry
2. **Подключается к Docker Registry** по указанному URL
3. **Получает список всех репозиториев** в registry
4. **Для каждого репозитория:**
   - Получает список всех тегов
   - Извлекает **реальное время создания** из Docker манифестов (v1 и v2)
   - Сортирует образы по времени создания (новые первыми)
   - Показывает план удаления
   - Удаляет все образы кроме 2 самых новых

## Устранение проблем

### Ошибка 405 "Method Not Allowed"

Если вы видите ошибку:
```
Ошибка при удалении: получен статус 405 при удалении манифеста
```

Это означает, что ваш Docker Registry не настроен для поддержки удаления. 

**Быстрое решение:**
1. Добавьте в конфигурацию Registry (`config.yml`):
   ```yaml
   storage:
     delete:
       enabled: true
   ```
2. Или используйте переменную окружения:
   ```bash
   REGISTRY_STORAGE_DELETE_ENABLED=true
   ```

📋 **Подробные инструкции см. в файле `REGISTRY_SETUP.md`**

## Пример вывода

```
Подключение к Docker Registry: http://localhost:5000
Проверка поддержки удаления в Registry...
Найдено 2 репозиториев

Обработка репозитория: payment-service
  Образ payment-service:20250430-020712 создан 2025-04-30 02:09:14
  Образ payment-service:20250425-141523 создан 2025-04-25 14:15:23
  Образ payment-service:20250420-093045 создан 2025-04-20 09:30:45

  Образы отсортированы по времени создания (новые первыми):
    1. payment-service:20250430-020712 (2025-04-30 02:09:14) - сохранить
    2. payment-service:20250425-141523 (2025-04-25 14:15:23) - сохранить
    3. payment-service:20250420-093045 (2025-04-20 09:30:45) - удалить

  Найдено 3 образов, сохраняем 2 новейших, удаляем 1 старых
  Удаляем payment-service:20250420-093045 (создан: 2025-04-20 09:30:45, digest: sha256:abc123...)
  Успешно удален payment-service:20250420-093045

Очистка завершена!

Важно: После удаления манифестов запустите garbage collection в Registry:
docker exec <registry-container> registry garbage-collect /etc/docker/registry/config.yml
```

## Безопасность

- Программа поддерживает Basic Authentication
- Перед удалением показывает подробный план действий
- Всегда сохраняет минимум 2 последних образа
- Предупреждает о необходимости garbage collection

## Требования

- Docker Registry должен поддерживать Docker Registry HTTP API V2
- Для удаления образов Registry должен быть настроен с параметром `delete: enabled: true`
- Go 1.24+ для компиляции из исходного кода

GC
kubectl exec -it docker-registry-76f4cdb5c-l7ngn -n  docker-registry -- registry garbage-collect --delete-untagged=true /etc/docker/registry/config.yml 
